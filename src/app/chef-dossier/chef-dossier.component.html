<div class="chef-dossier-container">
  <!-- Header -->
  <div class="chef-header">
    <div class="chef-info">
      <h1><i class="fas fa-user-tie"></i> Interface Chef Dossier</h1>
      <p>Bienvenue, {{ currentUser?.prenom }} {{ currentUser?.nom }}</p>
      <span class="role-badge">{{ getRoleDisplayName(currentUser?.roleUtilisateur!) }}</span>
    </div>
    <!-- Suppression des boutons pour épurer le header -->
  </div>

  <!-- Actions Rapides - Nouveau Système -->
  <div class="quick-actions-new-section">
    <h2><i class="fas fa-bolt"></i> Actions Rapides</h2>
    <div class="actions-grid">
      <a routerLink="/dossier/notifications/envoyer" class="action-card">
        <div class="action-icon">
          <i class="fas fa-paper-plane"></i>
        </div>
        <div class="action-content">
          <h4>Envoyer Notification</h4>
          <p>Envoyer une notification à tous mes agents</p>
        </div>
      </a>

      <a routerLink="/dossier/taches/create" class="action-card">
        <div class="action-icon">
          <i class="fas fa-tasks"></i>
        </div>
        <div class="action-content">
          <h4>Créer une Tâche</h4>
          <p>Assigner une tâche urgente à un agent</p>
        </div>
      </a>
    </div>
  </div>

  <!-- Statistiques Complètes - Nouveau Système -->
  <div class="stats-completes-section" *ngIf="statsDepartement && !loadingStatsCompletes">
    <h2><i class="fas fa-chart-bar"></i> Statistiques Complètes du Département</h2>
    <div class="stats-grid-completes">
      <app-stat-card 
        title="Mes Agents"
        [stats]="{
          'Nombre d\'agents': statsDepartement.nombreAgents || 0,
          'Agents dans le département': (statsDepartement.agents && statsDepartement.agents.length) ? statsDepartement.agents.length : 0
        }"
        icon="people"
        color="primary">
      </app-stat-card>

      <app-stat-card 
        title="Dossiers du Département"
        [stats]="{
          'Total': statsDepartement.totalDossiersDepartement || 0,
          'Clôturés': (statsDepartement.chef && statsDepartement.chef.dossiersClotures !== null && statsDepartement.chef.dossiersClotures !== undefined) ? statsDepartement.chef.dossiersClotures : 0,
          'En cours': (statsDepartement.chef && statsDepartement.chef.dossiersTraites !== null && statsDepartement.chef.dossiersTraites !== undefined) ? ((statsDepartement.chef.dossiersTraites - (statsDepartement.chef.dossiersClotures || 0))) : 0
        }"
        icon="folder"
        color="accent">
      </app-stat-card>

      <app-stat-card 
        title="Enquêtes"
        [stats]="{
          'Total': statistiques.totalEnquetes || 0,
          'Complétées': statistiques.enquetesCompletees || 0,
          'En cours': statistiques.enquetesEnCours || 0
        }"
        icon="search"
        color="primary">
      </app-stat-card>

      <app-stat-card 
        *ngIf="statsDepartement.chef && statsDepartement.chef.tauxReussite !== null && statsDepartement.chef.tauxReussite !== undefined"
        title="Performance"
        [stats]="{
          'Taux de réussite': (statsDepartement.chef.tauxReussite * 100).toFixed(2) + '%',
          'Montant récupéré': formatAmount(statsDepartement.chef.montantRecouvre || 0),
          'Montant en cours': formatAmount(statsDepartement.chef.montantEnCours || 0)
        }"
        icon="trending_up"
        color="accent">
      </app-stat-card>
    </div>
  </div>
  <div *ngIf="loadingStatsCompletes" class="loading-stats">
    <i class="fas fa-spinner fa-spin"></i> Chargement des statistiques...
  </div>

  <!-- Statistiques (Ancien Système - Conservé) -->
  <div class="statistiques-section">
    <h2><i class="fas fa-chart-bar"></i> Tableau de Bord</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-folder-open"></i>
        </div>
        <div class="stat-content">
          <h3>{{ statistiques.totalDossiers || 0 }}</h3>
          <p>Total Dossiers</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
          <h3>{{ statistiques.dossiersEnCours || 0 }}</h3>
          <p>En Cours</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-handshake"></i>
        </div>
        <div class="stat-content">
          <h3>{{ statistiques.dossiersParPhaseAmiable || 0 }}</h3>
          <p>Recouvrement Amiable</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-gavel"></i>
        </div>
        <div class="stat-content">
          <h3>{{ statistiques.dossiersParPhaseJuridique || 0 }}</h3>
          <p>Recouvrement Juridique</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
          <h3>{{ statistiques.dossiersClotures || 0 }}</h3>
          <p>Clôturés</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-calendar-plus"></i>
        </div>
        <div class="stat-content">
          <h3>{{ statistiques.dossiersCreesCeMois || 0 }}</h3>
          <p>Créés ce Mois</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <h3>{{ statistiques.agentsActifs || 0 }}</h3>
          <p>Agents Actifs</p>
        </div>
      </div>
      
      <!-- Nouvelle section : Statistiques d'Enquêtes (Prompt 2) -->
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-search"></i>
        </div>
        <div class="stat-content">
          <h3>{{ statistiques.totalEnquetes || 0 }}</h3>
          <p>Total Enquêtes</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
          <h3>{{ statistiques.enquetesCompletees || 0 }}</h3>
          <p>Enquêtes Complétées</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
          <h3>{{ statistiques.enquetesEnCours || 0 }}</h3>
          <p>Enquêtes en Cours</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-content">
          <h3>{{ statistiques.tachesUrgentes || 0 }}</h3>
          <p>Tâches Urgentes</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Section Prédictions IA -->
  <div class="ia-predictions-section" *ngIf="recentDossiers.length > 0">
    <h2><i class="fas fa-brain"></i> Prédictions IA - Dossiers Récents</h2>
    <div class="predictions-grid">
      <div class="prediction-card" *ngFor="let dossier of recentDossiers">
        <div class="dossier-header-prediction">
          <h4>{{ dossier.numeroDossier || 'Sans référence' }}</h4>
          <span class="montant-badge">{{ formatAmount(dossier.montantCreance || 0) }}</span>
        </div>
        <div class="prediction-content">
          <app-ia-prediction-badge
            [prediction]="getPrediction(dossier)"
            [loading]="isLoadingPrediction(dossier)"
            [showDetails]="true"
            size="small"
          ></app-ia-prediction-badge>
          <button 
            *ngIf="!getPrediction(dossier) && !isLoadingPrediction(dossier)"
            class="btn btn-sm btn-primary"
            (click)="triggerPrediction(dossier.id!)"
            title="Calculer Prédiction IA">
            <i class="fas fa-brain"></i> Calculer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance des Agents (remplace les Actions Rapides) -->
  <div class="performance-agents-section" *ngIf="agentPerformance && agentPerformance.length > 0">
    <h2><i class="fas fa-user-chart"></i> Performance des Agents</h2>
    <div class="performance-grid">
      <div class="perf-card" *ngFor="let a of agentPerformance">
        <div class="perf-header">
          <div class="agent-initials">{{ (a.prenom && a.prenom.length > 0) ? a.prenom.charAt(0) : '' }}{{ (a.nom && a.nom.length > 0) ? a.nom.charAt(0) : '' }}</div>
          <div class="agent-info">
            <h4>{{ a.prenom || '' }} {{ a.nom || '' }}</h4>
            <span class="badge" [ngClass]="getPerformanceClass(a.performance)">{{ a.performance | uppercase }}</span>
          </div>
        </div>
        <div class="perf-metrics">
          <div><span class="metric">{{ a.dossiersTraites || 0 }}</span><span class="label">Traités</span></div>
          <div><span class="metric">{{ a.dossiersClotures || 0 }}</span><span class="label">Clôturés</span></div>
          <div><span class="metric">{{ (a.tauxReussite || 0) | number:'1.0-1' }}%</span><span class="label">Taux</span></div>
          <div><span class="metric">{{ formatAmount(a.montantRecupere || 0) }}</span><span class="label">Recouvré</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tâches Urgentes -->
  <div class="taches-section" *ngIf="tachesUrgentes && tachesUrgentes.length > 0">
    <h2><i class="fas fa-tasks"></i> Tâches Urgentes</h2>
    <div class="taches-list">
      <div class="tache-item" *ngFor="let tache of tachesUrgentes">
        <div class="tache-priority" [ngClass]="'priorite-' + (tache.priorite ? tache.priorite.toLowerCase() : 'moyenne')">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="tache-content">
          <h4>{{ tache.titre || 'Tâche sans titre' }}</h4>
          <p>{{ tache.description || 'Aucune description' }}</p>
          <div class="tache-meta">
            <span class="tache-agent">{{ tache.agentNom || 'Non assigné' }}</span>
            <span class="tache-date">{{ tache.dateEcheance ? (tache.dateEcheance | date:'dd/MM/yyyy') : 'Non définie' }}</span>
          </div>
        </div>
        <div class="tache-actions">
          <button class="btn btn-sm btn-success">Terminer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notifications -->
  <div class="notifications-section" *ngIf="notifications && notifications.length > 0">
    <h2><i class="fas fa-bell"></i> Notifications Récentes</h2>
    <div class="notifications-list">
      <div class="notification-item" *ngFor="let notification of notifications">
        <div class="notification-icon">
          <i class="fas fa-info-circle"></i>
        </div>
        <div class="notification-content">
          <h4>{{ notification.titre || 'Notification' }}</h4>
          <p>{{ notification.message || 'Aucun message' }}</p>
          <small>{{ notification.dateCreation ? (notification.dateCreation | date:'dd/MM/yyyy HH:mm') : 'Date inconnue' }}</small>
        </div>
      </div>
    </div>
  </div>
</div>
