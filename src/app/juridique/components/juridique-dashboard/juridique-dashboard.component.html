<div class="juridique-dashboard">
  <div class="dashboard-header">
    <div class="header-content">
      <h1>
        <i class="fas fa-gavel"></i>
        Tableau de Bord Juridique
      </h1>
      <p class="welcome-message" *ngIf="currentUser">
        Bienvenue, <strong>{{ currentUser.prenom }} {{ currentUser.nom }}</strong>
        <span class="role-badge">{{ getRoleDisplayName() }}</span>
      </p>
      <p class="subtitle" *ngIf="!currentUser">Vue d'ensemble des activités juridiques</p>
    </div>
  </div>

  <!-- Actions Rapides - Nouveau Système -->
  <div class="quick-actions-new-section">
    <h2><i class="fas fa-bolt"></i> Actions Rapides</h2>
    <div class="actions-grid">
      <a routerLink="/juridique/notifications/envoyer" class="action-card">
        <div class="action-icon">
          <i class="fas fa-paper-plane"></i>
        </div>
        <div class="action-content">
          <h4>Envoyer Notification</h4>
          <p>Envoyer une notification à tous mes agents</p>
        </div>
      </a>

      <a routerLink="/juridique/taches/create" class="action-card">
        <div class="action-icon">
          <i class="fas fa-tasks"></i>
        </div>
        <div class="action-content">
          <h4>Créer une Tâche</h4>
          <p>Assigner une tâche urgente à un agent</p>
        </div>
      </a>
    </div>
  </div>

  <!-- Statistiques Complètes - Nouveau Système -->
  <div class="stats-completes-section" *ngIf="statsDepartement && !loadingStatsCompletes">
    <h2><i class="fas fa-chart-bar"></i> Statistiques Complètes du Département</h2>
    <div class="stats-grid-completes">
      <app-stat-card 
        *ngIf="statsDepartement.nombreAgents !== null && statsDepartement.nombreAgents !== undefined"
        title="Mes Agents"
        [stats]="{
          'Nombre d\'agents': statsDepartement.nombreAgents ?? 0,
          'Agents dans le département': (statsDepartement.agents && statsDepartement.agents.length) ? statsDepartement.agents.length : 0
        }"
        icon="people"
        color="primary">
      </app-stat-card>

      <app-stat-card 
        *ngIf="statsDepartement.totalDossiersDepartement !== null && statsDepartement.totalDossiersDepartement !== undefined && statsDepartement.chef"
        title="Dossiers du Département"
        [stats]="{
          'Total': statsDepartement.totalDossiersDepartement ?? 0,
          'Clôturés': (statsDepartement.chef.dossiersClotures !== null && statsDepartement.chef.dossiersClotures !== undefined) ? statsDepartement.chef.dossiersClotures : 0,
          'En cours': (statsDepartement.chef.dossiersTraites !== null && statsDepartement.chef.dossiersTraites !== undefined) ? ((statsDepartement.chef.dossiersTraites - (statsDepartement.chef.dossiersClotures || 0))) : 0
        }"
        icon="folder"
        color="accent">
      </app-stat-card>

      <!-- Prompt 4 : Section Audiences -->
      <app-stat-card 
        *ngIf="statsAudiences"
        title="Audiences"
        [stats]="{
          'Total': statsAudiences.total ?? 0,
          'Prochaines (7j)': statsAudiences.prochaines ?? 0,
          'Passées': statsAudiences.passees ?? 0
        }"
        icon="event"
        color="primary">
      </app-stat-card>

      <!-- Prompt 4 : Section Documents Huissier -->
      <app-stat-card 
        *ngIf="statsDocumentsHuissier"
        title="Documents Huissier"
      [stats]="{
        'Complétés': (statsDocumentsHuissier.completes !== null && statsDocumentsHuissier.completes !== undefined) ? statsDocumentsHuissier.completes : 0,
        'Créés': (statsDocumentsHuissier.crees !== null && statsDocumentsHuissier.crees !== undefined) ? statsDocumentsHuissier.crees : 0
      }"
        icon="description"
        color="accent">
      </app-stat-card>

      <!-- Prompt 4 : Section Actions Huissier -->
      <app-stat-card 
        *ngIf="statsActionsHuissier"
        title="Actions Huissier"
      [stats]="{
        'Complétées': (statsActionsHuissier.completes !== null && statsActionsHuissier.completes !== undefined) ? statsActionsHuissier.completes : 0,
        'Créées': (statsActionsHuissier.crees !== null && statsActionsHuissier.crees !== undefined) ? statsActionsHuissier.crees : 0
      }"
        icon="gavel"
        color="primary">
      </app-stat-card>

      <app-stat-card 
        *ngIf="statsDepartement.chef && (statsDepartement.chef.tauxReussite !== null || statsDepartement.chef.montantRecouvre !== null || statsDepartement.chef.montantEnCours !== null)"
        title="Performance"
        [stats]="{
          'Taux de réussite': (statsDepartement.chef.tauxReussite !== null && statsDepartement.chef.tauxReussite !== undefined) ? (statsDepartement.chef.tauxReussite * 100).toFixed(2) + '%' : '0%',
          'Montant récupéré': formatAmount(statsDepartement.chef.montantRecouvre || 0),
          'Montant en cours': formatAmount(statsDepartement.chef.montantEnCours || 0)
        }"
        icon="trending_up"
        color="accent">
      </app-stat-card>
    </div>

    <!-- ✅ NOUVEAU : Section Recouvrement par Phase -->
    <div class="recouvrement-phase-section" *ngIf="statsRecouvrement">
      <div class="section-header">
        <h3><i class="fas fa-chart-pie"></i> Recouvrement par Phase</h3>
      </div>
      <div class="phase-cards">
        <app-stat-card 
          title="Recouvrement Juridique"
          [stats]="{
            'Montant recouvré': formatAmount(statsRecouvrement.montantRecouvrePhaseJuridique || 0),
            'Nombre de dossiers': statsRecouvrement.dossiersAvecRecouvrementJuridique || 0,
            'Taux de recouvrement': (statsRecouvrement.tauxRecouvrementJuridique || 0).toFixed(2) + '%'
          }"
          icon="gavel"
          color="primary">
        </app-stat-card>

        <app-stat-card 
          title="Vue d'Ensemble"
          [stats]="{
            'Montant total recouvré': formatAmount(statsRecouvrement.montantRecouvreTotal || 0),
            'Montant total créances': formatAmount(statsRecouvrement.montantTotalCreances || 0)
          }"
          icon="chart-bar"
          color="accent">
        </app-stat-card>
      </div>
    </div>
  </div>
  <div *ngIf="loadingStatsCompletes" class="loading-stats">
    <i class="fas fa-spinner fa-spin"></i> Chargement des statistiques...
  </div>

  <!-- Section Agents -->
  <div class="agents-section" *ngIf="agentsJuridiques.length > 0">
    <h2><i class="fas fa-users"></i> Mes Agents ({{ agentsJuridiques.length }})</h2>
    <div class="agents-grid">
      <div class="agent-card" *ngFor="let agent of agentsJuridiques">
        <div class="agent-avatar">
          {{ agent.prenom.charAt(0) }}{{ agent.nom.charAt(0) }}
        </div>
        <div class="agent-info">
          <h4>{{ agent.prenom }} {{ agent.nom }}</h4>
          <p class="agent-email">{{ agent.email }}</p>
          <span class="agent-role-badge">Agent Juridique</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-folder-open"></i>
      </div>
      <div class="stat-content">
        <h3>{{ totalDossiers }}</h3>
        <p>Dossiers Juridiques</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-money-bill-wave"></i>
      </div>
      <div class="stat-content">
        <h3>{{ formatAmount(totalMontant) }}</h3>
        <p>Montant Total</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-clock"></i>
      </div>
      <div class="stat-content">
        <h3>{{ dossiersEnCours }}</h3>
        <p>En Cours</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-user-tie"></i>
      </div>
      <div class="stat-content">
        <h3>{{ totalAvocats }}</h3>
        <p>Avocats</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-balance-scale"></i>
      </div>
      <div class="stat-content">
        <h3>{{ totalHuissiers }}</h3>
        <p>Huissiers</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-gavel"></i>
      </div>
      <div class="stat-content">
        <h3>{{ totalAudiences }}</h3>
        <p>Audiences</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-user-tie"></i>
      </div>
      <div class="stat-content">
        <h3>{{ dossiersAvecAvocat }}</h3>
        <p>Avec Avocat</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-balance-scale"></i>
      </div>
      <div class="stat-content">
        <h3>{{ dossiersAvecHuissier }}</h3>
        <p>Avec Huissier</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="stat-content">
        <h3>{{ dossiersUrgents }}</h3>
        <p>Urgents</p>
      </div>
    </div>
  </div>

  <!-- Performance Statistics -->
  <div class="performance-section">
    <h2>Statistiques de Performance</h2>
    <div class="performance-grid">
      <div class="performance-card">
        <h3>Agents Juridiques</h3>
        <div class="agent-stats">
          <div class="agent-item" *ngFor="let agent of agentsJuridiques">
            <div class="agent-info">
              <span class="agent-name">{{ agent.prenom }} {{ agent.nom }}</span>
              <span class="agent-email">{{ agent.email }}</span>
            </div>
            <div class="agent-performance">
              <div class="performance-metric">
                <span class="metric-label">Dossiers traités:</span>
                <span class="metric-value">{{ getAgentPerformance(agent.id) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="performance-card">
        <h3>Décisions par Type</h3>
        <div class="decision-stats">
          <div class="decision-item">
            <span class="decision-type positive">Positives</span>
            <span class="decision-count">{{ decisionsPositives }}</span>
          </div>
          <div class="decision-item">
            <span class="decision-type negative">Négatives</span>
            <span class="decision-count">{{ decisionsNegatives }}</span>
          </div>
          <div class="decision-item">
            <span class="decision-type rapporter">Rapporter</span>
            <span class="decision-count">{{ decisionsRapporter }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Section Prédictions IA -->
  <div class="ia-predictions-section" *ngIf="recentDossiers.length > 0">
    <h2><i class="fas fa-brain"></i> Prédictions IA - Dossiers Récents</h2>
    <div class="predictions-grid">
      <div class="prediction-card" *ngFor="let dossier of recentDossiers">
        <div class="dossier-header-prediction">
          <h4>{{ dossier.numeroDossier || 'Sans référence' }}</h4>
          <span class="montant-badge">{{ formatAmount(dossier.montantCreance || 0) }}</span>
        </div>
        <div class="prediction-content">
          <app-ia-prediction-badge
            [prediction]="getPrediction(dossier)"
            [loading]="isLoadingPrediction(dossier)"
            [showDetails]="true"
            size="small"
          ></app-ia-prediction-badge>
          <button 
            *ngIf="!getPrediction(dossier) && !isLoadingPrediction(dossier)"
            class="btn btn-sm btn-primary"
            (click)="triggerPrediction(dossier.id!)"
            title="Calculer Prédiction IA">
            <i class="fas fa-brain"></i> Calculer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Activities -->
  <div class="recent-activities">
    <h2>Activités Récentes</h2>
    <div class="activities-list">
      <div class="activity-item" *ngFor="let activity of recentActivities">
        <div class="activity-icon">
          <i class="fas" [ngClass]="getActivityIcon(activity.type)"></i>
        </div>
        <div class="activity-content">
          <h4>{{ activity.title }}</h4>
          <p>{{ activity.description }}</p>
          <span class="activity-date">{{ activity.date | date:'dd/MM/yyyy HH:mm' }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
