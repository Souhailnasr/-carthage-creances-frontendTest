<div class="huissier-actions-container">
  <div class="header">
    <div class="header-content">
      <div>
        <h1>
          <i class="fas fa-gavel"></i>
          Actions Huissier
        </h1>
        <p class="subtitle">Gérez les actions huissier pour chaque dossier. Une fois les actions créées, vous pourrez passer aux audiences.</p>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-section">
    <div class="stat-card">
      <div class="stat-icon stat-primary">
        <i class="fas fa-folder"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.totalDossiers }}</div>
        <div class="stat-label">Dossiers</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon stat-info">
        <i class="fas fa-gavel"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.totalActions }}</div>
        <div class="stat-label">Actions Total</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon stat-warning">
        <i class="fas fa-lock"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.conservatoireActions }}</div>
        <div class="stat-label">Conservatoire</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon stat-success">
        <i class="fas fa-hammer"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.executiveActions }}</div>
        <div class="stat-label">Exécutive</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon stat-danger">
        <i class="fas fa-ban"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.blocageActions + stats.immobiliereActions }}</div>
        <div class="stat-label">Blocage/Immobilière</div>
      </div>
    </div>
  </div>

  <!-- Search and Filters Section -->
  <div class="filters-section">
    <div class="search-bar">
      <div class="search-input-group">
        <i class="fas fa-search"></i>
        <input 
          type="text" 
          [(ngModel)]="searchTerm" 
          (input)="applyFilters()" 
          placeholder="Rechercher par numéro de dossier, créancier, débiteur ou huissier..."
          class="search-input"
        >
        <button class="clear-search" *ngIf="searchTerm" (click)="searchTerm = ''; applyFilters()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    
    <div class="filter-buttons">
      <button 
        class="filter-btn" 
        [class.active]="filterType === 'all'"
        (click)="filterType = 'all'; applyFilters()">
        <i class="fas fa-list"></i> Tous
      </button>
      <button 
        class="filter-btn" 
        [class.active]="filterType === 'conservatoire'"
        (click)="filterType = 'conservatoire'; applyFilters()">
        <i class="fas fa-lock"></i> Conservatoire
      </button>
      <button 
        class="filter-btn" 
        [class.active]="filterType === 'executive'"
        (click)="filterType = 'executive'; applyFilters()">
        <i class="fas fa-hammer"></i> Exécutive
      </button>
      <button 
        class="filter-btn" 
        [class.active]="filterType === 'blocage'"
        (click)="filterType = 'blocage'; applyFilters()">
        <i class="fas fa-ban"></i> Blocage
      </button>
      <button 
        class="filter-btn" 
        [class.active]="filterType === 'immobiliere'"
        (click)="filterType = 'immobiliere'; applyFilters()">
        <i class="fas fa-building"></i> Immobilière
      </button>
    </div>
  </div>

  <!-- Dossiers with Actions -->
  <div class="dossiers-section">
    <div class="loading-spinner" *ngIf="isLoadingDossiers || isLoadingActions">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Chargement des dossiers et actions...</p>
    </div>
    
    <div class="dossiers-list" *ngIf="!isLoadingDossiers && !isLoadingActions && filteredDossiers.length > 0; else noDossiers">
      <div class="dossier-item" *ngFor="let dossier of filteredDossiers; trackBy: trackByDossierId">
        <div class="dossier-header">
          <div class="dossier-info">
            <h3 class="dossier-number">{{ dossier.numeroDossier || 'N/A' }}</h3>
            <div class="dossier-details">
              <span><strong>Créancier:</strong> {{ getCreancierName(dossier) }}</span>
              <span><strong>Débiteur:</strong> {{ getDebiteurName(dossier) }}</span>
              <span *ngIf="dossier.montantCreance"><strong>Montant:</strong> {{ dossier.montantCreance | currency:'TND':'symbol':'1.2-2' }}</span>
              
              <!-- Affichage de l'huissier affecté -->
              <div class="assignments-info" *ngIf="hasHuissier(dossier)">
                <div class="assignment-item">
                  <i class="fas fa-file-signature"></i>
                  <span><strong>Huissier:</strong> {{ getHuissierName(dossier) }}</span>
                </div>
              </div>
              <div class="no-assignment" *ngIf="!hasHuissier(dossier)">
                <i class="fas fa-exclamation-triangle"></i>
                <span class="warning-text">Aucun huissier affecté</span>
              </div>
              
              <!-- Étape actuelle du dossier -->
              <div class="dossier-etape" *ngIf="getDossierEtape(dossier) !== 'N/A'">
                <i class="fas fa-info-circle"></i>
                <span><strong>Étape:</strong> {{ getDossierEtape(dossier) }}</span>
              </div>
            </div>
          </div>
          <div class="dossier-actions-buttons">
            <button 
              class="btn btn-primary" 
              (click)="selectedDossier = dossier; selectedDossierId = dossier.id; openActionForm()"
              [disabled]="!canCreateAction(dossier) || isLoading"
              [title]="!canCreateAction(dossier) ? 'Ce dossier n\'est pas à l\'étape actions. Vous ne pouvez que consulter les actions existantes.' : 'Créer une nouvelle action'">
              <i class="fas fa-plus"></i> Créer Action
            </button>
            <!-- Bouton Passer aux Audiences (visible si à l'étape actions) -->
            <button 
              *ngIf="canCreateAction(dossier) && canPasserAuxAudiences(dossier)"
              class="btn btn-success"
              (click)="selectedDossier = dossier; selectedDossierId = dossier.id; passerAuxAudiences()"
              [disabled]="isLoading"
              title="Passer à l'étape Audiences">
              <i class="fas fa-arrow-right"></i> Passer aux Audiences
            </button>
            <!-- Bouton Affecter au Finance -->
            <button 
              *ngIf="canAffecterAuFinance(dossier)"
              class="btn btn-info"
              (click)="selectedDossier = dossier; selectedDossierId = dossier.id; affecterAuFinance()"
              [disabled]="isLoadingAffectationFinance || isLoading"
              title="Affecter ce dossier au département finance">
              <i class="fas fa-money-bill-wave"></i> 
              <span *ngIf="isLoadingAffectationFinance">
                <i class="fas fa-spinner fa-spin"></i> Affectation...
              </span>
              <span *ngIf="!isLoadingAffectationFinance">Affecter au Finance</span>
            </button>
          </div>
        </div>

        <!-- IA Prediction Badge -->
        <div class="ia-prediction-section">
          <app-ia-prediction-badge
            [prediction]="getPredictionForDossier(dossier)"
            [loading]="loadingPrediction && selectedDossierId === dossier.id"
            [showDetails]="true"
            size="medium"
          ></app-ia-prediction-badge>
          <button
            *ngIf="!getPredictionForDossier(dossier) && !loadingPrediction"
            class="btn btn-sm btn-outline-primary"
            (click)="triggerPrediction(dossier.id!)"
            title="Calculer Prédiction IA">
            <i class="fas fa-brain"></i> Calculer Prédiction IA
          </button>
          <button
            *ngIf="getPredictionForDossier(dossier) && !loadingPrediction"
            class="btn btn-sm btn-outline-secondary"
            (click)="triggerPrediction(dossier.id!)"
            title="Recalculer Prédiction IA">
            <i class="fas fa-sync-alt"></i> Recalculer Prédiction IA
          </button>
        </div>

        <!-- Actions for this dossier -->
        <div class="actions-list-section" *ngIf="getFilteredActionsForDossier(dossier.id).length > 0">
          <div class="actions-header">
            <h4>
              <i class="fas fa-gavel"></i>
              Actions ({{ getFilteredActionsForDossier(dossier.id).length }})
            </h4>
          </div>
          <div class="actions-list">
            <div class="action-card" 
                 *ngFor="let action of getFilteredActionsForDossier(dossier.id); trackBy: trackByActionId">
              <div class="action-card-header">
                <div class="action-main-info">
                  <div class="action-type-badge">
                    <i class="fas fa-gavel"></i>
                    <span>{{ getActionTypeLabel(action.typeAction) }}</span>
                  </div>
                  <div class="action-date-badge">
                    <i class="fas fa-calendar"></i>
                    <span>{{ formatDate(action.dateAction) }}</span>
                  </div>
                  <div class="action-etat-badge" *ngIf="action.etatDossier">
                    <i class="fas fa-info-circle"></i>
                    <span>{{ getEtatDossierLabel(action.etatDossier) }}</span>
                  </div>
                </div>
                <div class="action-actions">
                  <button class="action-btn view-btn" (click)="selectedDossier = dossier; selectedDossierId = dossier.id; viewAction(action)" title="Voir les détails">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button 
                    class="action-btn edit-btn" 
                    (click)="selectedDossier = dossier; selectedDossierId = dossier.id; openActionForm(action)" 
                    [disabled]="!canCreateAction(dossier)"
                    title="Modifier">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button 
                    class="action-btn delete-btn" 
                    (click)="selectedDossier = dossier; selectedDossierId = dossier.id; deleteAction(action)" 
                    [disabled]="!canCreateAction(dossier)"
                    title="Supprimer">
                    <i class="fas fa-trash"></i>
                  </button>
                  <button 
                    class="action-btn attachment-btn" 
                    *ngIf="action.pieceJointeUrl"
                    (click)="openDocument(action.pieceJointeUrl!)" 
                    title="Ouvrir la pièce jointe">
                    <i class="fas fa-external-link-alt"></i>
                  </button>
                </div>
              </div>
              
              <div class="action-details">
                <div class="detail-row">
                  <i class="fas fa-user-shield"></i>
                  <span><strong>Huissier:</strong> {{ action.huissierName }}</span>
                </div>
                <div class="detail-row" *ngIf="action.montantRecouvre">
                  <i class="fas fa-money-bill-wave"></i>
                  <span><strong>Montant Recouvré:</strong> {{ action.montantRecouvre | number:'1.2-2' }} TND</span>
                </div>
                <div class="detail-row" *ngIf="action.montantRestant">
                  <i class="fas fa-money-bill"></i>
                  <span><strong>Montant Restant:</strong> {{ action.montantRestant | number:'1.2-2' }} TND</span>
                </div>
                <div class="detail-row" *ngIf="action.pieceJointeUrl">
                  <i class="fas fa-paperclip"></i>
                  <span>
                    <strong>Pièce jointe:</strong> 
                    <button class="btn-link" (click)="openDocument(action.pieceJointeUrl!)">
                      <i class="fas fa-external-link-alt"></i> Ouvrir
                    </button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Message si aucune action -->
        <div class="no-actions" *ngIf="getActionsForDossier(dossier.id).length === 0">
          <div class="empty-state">
            <i class="fas fa-gavel"></i>
            <p>Aucune action enregistrée pour ce dossier.</p>
            <button 
              *ngIf="canCreateAction(dossier)"
              class="btn btn-outline-primary" 
              (click)="selectedDossier = dossier; selectedDossierId = dossier.id; openActionForm()">
              <i class="fas fa-plus"></i> Créer la première action
            </button>
          </div>
        </div>
        
        <!-- Message si actions filtrées vides mais actions existent -->
        <div class="no-actions-filtered" *ngIf="getFilteredActionsForDossier(dossier.id).length === 0 && getActionsForDossier(dossier.id).length > 0">
          <div class="empty-state">
            <i class="fas fa-filter"></i>
            <p>Aucune action ne correspond aux filtres sélectionnés.</p>
            <button class="btn btn-outline-secondary" (click)="filterType = 'all'; applyFilters()">
              <i class="fas fa-times"></i> Réinitialiser les filtres
            </button>
          </div>
        </div>
      </div>
    </div>

    <ng-template #noDossiers>
      <div class="no-dossiers">
        <i class="fas fa-folder-open"></i>
        <h3>Aucun dossier trouvé</h3>
        <p>Aucun dossier n'est disponible pour la gestion des actions huissier.</p>
      </div>
    </ng-template>
  </div>

  <!-- Modal de création/modification d'action -->
  <div class="modal-overlay" 
       *ngIf="showActionForm"
       (click)="closeActionForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <i class="fas" 
             [class.fa-plus]="!isEditActionMode" 
             [class.fa-edit]="isEditActionMode"></i>
          {{ isEditActionMode ? 'Modifier une Action Huissier' : 'Créer une Action Huissier' }}
        </h2>
        <button class="close-btn" (click)="closeActionForm()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="dossier-info-modal" *ngIf="selectedDossier">
          <h3>{{ selectedDossier.numeroDossier || 'N/A' }}</h3>
          <div class="dossier-info-grid">
            <div class="info-section">
              <h4><i class="fas fa-info-circle"></i> Informations générales</h4>
              <p *ngIf="selectedDossier.titre"><strong>Titre:</strong> {{ selectedDossier.titre }}</p>
              <p *ngIf="selectedDossier.montantCreance">
                <strong>Montant:</strong> {{ selectedDossier.montantCreance | currency:'TND':'symbol':'1.2-2' }}
              </p>
            </div>
            <div class="info-section">
              <h4><i class="fas fa-users"></i> Parties</h4>
              <p><strong>Créancier:</strong> {{ getCreancierName(selectedDossier) }}</p>
              <p><strong>Débiteur:</strong> {{ getDebiteurName(selectedDossier) }}</p>
            </div>
            <div class="info-section" *ngIf="hasHuissier(selectedDossier)">
              <h4><i class="fas fa-user-shield"></i> Huissier affecté</h4>
              <p><strong>Huissier:</strong> {{ getHuissierName(selectedDossier) }}</p>
            </div>
          </div>
        </div>

        <form class="action-form">
          <div class="form-group">
            <label for="typeAction">Type d'Action *</label>
            <select 
              id="typeAction"
              class="form-control"
              [(ngModel)]="actionForm.typeAction"
              name="typeAction"
              [disabled]="isLoading">
              <option [value]="TypeActionHuissier.ACLA_TA7AFOUDHIA">Saisie Conservatoire (العقلة التحفظية)</option>
              <option [value]="TypeActionHuissier.ACLA_TANFITHIA">Saisie Exécutive (العقلة التنفيذية)</option>
              <option [value]="TypeActionHuissier.ACLA_TAW9IFIYA">Saisie de Blocage (العقلة التوقيفية)</option>
              <option [value]="TypeActionHuissier.ACLA_A9ARYA">Saisie Immobilière (العقلة العقارية)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="huissierName">Nom de l'Huissier *</label>
            <input 
              type="text"
              id="huissierName"
              class="form-control"
              [(ngModel)]="actionForm.huissierName"
              name="huissierName"
              [disabled]="true"
              [readonly]="true"
              placeholder="Rempli automatiquement depuis le dossier">
            <small class="form-text text-muted">
              Rempli automatiquement depuis l'huissier affecté au dossier
            </small>
          </div>

          <div class="form-group">
            <label for="montantRecouvre">Montant Recouvré (TND) *</label>
            <input 
              type="number"
              id="montantRecouvre"
              class="form-control"
              [(ngModel)]="actionForm.montantRecouvre"
              (ngModelChange)="onMontantRecouvreChange()"
              name="montantRecouvre"
              [disabled]="isLoading"
              step="0.01"
              min="0"
              placeholder="Ex: 1500.50"
              required>
            <small class="form-text text-muted">
              Le montant restant sera calculé automatiquement
            </small>
          </div>

          <div class="form-group">
            <label for="montantRestant">Montant Restant (TND)</label>
            <input 
              type="number"
              id="montantRestant"
              class="form-control"
              [ngModel]="actionForm.montantRestant"
              name="montantRestant"
              [disabled]="true"
              step="0.01"
              min="0"
              placeholder="Calculé automatiquement"
              readonly>
            <small class="form-text text-muted">
              Calculé automatiquement : Montant Total - Montant Recouvré (cumulé)
            </small>
          </div>

          <div class="form-group">
            <label for="etatDossier">État du Dossier</label>
            <select 
              id="etatDossier"
              class="form-control"
              [(ngModel)]="actionForm.etatDossier"
              name="etatDossier"
              [disabled]="isLoading">
              <option [ngValue]="undefined">Sélectionner...</option>
              <option [value]="EtatDossier.EN_COURS">En Cours</option>
              <option [value]="EtatDossier.CLOTURE">Clôturé</option>
              <option [value]="EtatDossier.SUSPENDU">Suspendu</option>
            </select>
          </div>

          <div class="form-group">
            <label for="pieceJointe">Pièce Jointe</label>
            <input 
              type="file"
              id="pieceJointe"
              class="form-control"
              (change)="onFileSelected($event)"
              [disabled]="isLoading"
              accept=".pdf,.jpg,.jpeg,.png">
            <small class="form-text text-muted">
              Formats acceptés : PDF, JPEG, PNG. Taille maximale : 10MB
            </small>
            <div *ngIf="selectedFile" class="mt-2">
              <span class="badge badge-info">
                <i class="fas fa-file"></i> {{ selectedFile.name }} ({{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB)
              </span>
            </div>
            <div *ngIf="!selectedFile && actionForm.pieceJointeUrl" class="mt-2">
              <span class="badge badge-secondary">
                <i class="fas fa-link"></i> Fichier existant : <a [href]="actionForm.pieceJointeUrl" target="_blank">Voir</a>
              </span>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeActionForm()">
          Annuler
        </button>
        <button type="button" class="btn btn-primary" (click)="createAction()" [disabled]="isLoading">
          <span *ngIf="isLoading" class="spinner-border spinner-border-sm mr-2"></span>
          {{ isEditActionMode ? 'Modifier' : 'Créer' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de visualisation d'action -->
  <div class="modal-overlay" 
       *ngIf="showActionView && selectedAction"
       (click)="closeActionView()">
    <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <i class="fas fa-gavel"></i> Détails de l'Action
        </h2>
        <button class="close-btn" (click)="closeActionView()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="action-details-view">
          <div class="detail-row">
            <span class="detail-label">Type d'Action:</span>
            <span class="detail-value">{{ getActionTypeLabel(selectedAction.typeAction) }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Date:</span>
            <span class="detail-value">{{ formatDate(selectedAction.dateAction) }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Montant Recouvré:</span>
            <span class="detail-value">{{ selectedAction.montantRecouvre ? (selectedAction.montantRecouvre | number:'1.2-2') + ' TND' : '-' }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Montant Restant:</span>
            <span class="detail-value">{{ selectedAction.montantRestant ? (selectedAction.montantRestant | number:'1.2-2') + ' TND' : '-' }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">État du Dossier:</span>
            <span class="detail-value">
              <span class="badge badge-info" *ngIf="selectedAction.etatDossier">
                {{ getEtatDossierLabel(selectedAction.etatDossier) }}
              </span>
              <span *ngIf="!selectedAction.etatDossier" class="text-muted">-</span>
            </span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Huissier:</span>
            <span class="detail-value">{{ selectedAction.huissierName }}</span>
          </div>
          <div class="detail-row" *ngIf="selectedAction.pieceJointeUrl">
            <span class="detail-label">Pièce Jointe:</span>
            <span class="detail-value">
              <button class="btn btn-sm btn-info" (click)="openDocument(selectedAction.pieceJointeUrl!)">
                <i class="fas fa-external-link-alt"></i> Ouvrir
              </button>
            </span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeActionView()">
          Fermer
        </button>
        <button 
          *ngIf="canCreateAction(selectedDossier!)"
          type="button" 
          class="btn btn-warning" 
          (click)="openActionForm(selectedAction); closeActionView()">
          <i class="fas fa-edit"></i> Modifier
        </button>
      </div>
    </div>
  </div>
</div>
