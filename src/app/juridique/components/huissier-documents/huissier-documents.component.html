<div class="huissier-documents-container">
  <div class="page-header">
    <h2>
      <i class="fas fa-file-alt"></i>
      Documents Huissier
    </h2>
    <p class="subtitle">Créez et gérez les documents huissier pour chaque dossier. Une fois les documents créés, vous pourrez passer aux actions.</p>
  </div>

  <!-- Sélection du dossier et de l'huissier -->
  <div class="selection-section">
    <div class="row g-3">
      <div class="col-md-6">
        <label for="dossier-select" class="form-label">
          <i class="fas fa-folder-open"></i> Sélectionner un dossier *
        </label>
        <select 
          id="dossier-select"
          class="form-control"
          [(ngModel)]="selectedDossierId"
          (change)="onDossierSelected(selectedDossierId)"
          [disabled]="isLoadingDossiers || isLoading">
          <option [ngValue]="null">Sélectionner un dossier...</option>
          <option *ngFor="let dossier of dossiers" [ngValue]="dossier.id">
            {{ dossier.numeroDossier || 'Dossier #' + dossier.id }} - 
            {{ dossier.creancier?.nom || 'N/A' }}
            <span *ngIf="getDossierEtape(dossier) !== 'N/A'"> ({{ getDossierEtape(dossier) }})</span>
          </option>
        </select>
      </div>
      <div class="col-md-6">
        <label for="huissier-select" class="form-label">
          <i class="fas fa-user-shield"></i> Sélectionner un huissier
        </label>
        <select 
          id="huissier-select"
          class="form-control"
          [(ngModel)]="selectedHuissierId"
          [disabled]="isLoading">
          <option [ngValue]="null">Sélectionner un huissier...</option>
          <option *ngFor="let huissier of huissiers" [ngValue]="huissier.id">
            {{ huissier.prenom }} {{ huissier.nom }}
          </option>
        </select>
      </div>
    </div>
  </div>

  <!-- Section Documents -->
  <div class="documents-section" *ngIf="selectedDossierId">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>
        <i class="fas fa-file-alt"></i>
        Documents du Dossier
      </h3>
      <div class="d-flex align-items-center gap-3">
        <span *ngIf="selectedDossier" class="badge badge-info">
          <i class="fas fa-info-circle"></i> Étape actuelle : {{ getDossierEtape(selectedDossier) }}
        </span>
        <button 
          class="btn btn-primary"
          (click)="openDocumentForm()"
          [disabled]="isLoading || !canCreateDocument(selectedDossier!)"
          [title]="!canCreateDocument(selectedDossier!) ? 'Ce dossier est passé aux actions ou audiences. Vous ne pouvez que consulter les documents existants.' : 'Créer un nouveau document'">
          <i class="fas fa-plus"></i> Créer un Document
        </button>
      </div>
    </div>

    <!-- Liste des documents -->
    <div *ngIf="isLoadingDocuments" class="text-center py-5">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Chargement...</span>
      </div>
      <p class="mt-3 text-muted">Chargement des documents...</p>
    </div>

    <div *ngIf="!isLoadingDocuments && documents.length === 0" class="alert alert-info">
      <i class="fas fa-info-circle"></i> 
      <div>
        <strong>Aucun document trouvé.</strong> 
        Créez votre premier document pour ce dossier en cliquant sur le bouton "Créer un Document".
      </div>
    </div>

    <div *ngIf="!isLoadingDocuments && documents.length > 0" class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Type</th>
            <th>Date de Création</th>
            <th>Délai Légal</th>
            <th>Date d'Expiration</th>
            <th>Statut</th>
            <th>Huissier</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let document of documents" 
              [class.table-warning]="isDocumentExpired(document) && document.status !== StatutDocumentHuissier.EXPIRED"
              [class.table-danger]="document.status === StatutDocumentHuissier.EXPIRED"
              [class.table-success]="document.status === StatutDocumentHuissier.COMPLETED">
            <td>{{ getDocumentTypeLabel(document.typeDocument) }}</td>
            <td>{{ formatDate(document.dateCreation) }}</td>
            <td>{{ document.delaiLegalDays }} jours</td>
            <td>{{ getExpirationDate(document) }}</td>
            <td>
              <span class="badge" 
                    [class.badge-warning]="document.status === StatutDocumentHuissier.PENDING"
                    [class.badge-danger]="document.status === StatutDocumentHuissier.EXPIRED"
                    [class.badge-success]="document.status === StatutDocumentHuissier.COMPLETED">
                {{ getStatusLabel(document.status) }}
              </span>
            </td>
            <td>{{ document.huissierName }}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-sm btn-info" 
                        (click)="viewDocument(document)"
                        title="Visualiser"
                        style="border-radius: 6px; padding: 0.4rem 0.8rem; margin-right: 0.25rem;">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-warning" 
                        (click)="openDocumentForm(document)"
                        title="Modifier"
                        style="border-radius: 6px; padding: 0.4rem 0.8rem; margin-right: 0.25rem;">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" 
                        (click)="deleteDocument(document)"
                        title="Supprimer"
                        style="border-radius: 6px; padding: 0.4rem 0.8rem; margin-right: 0.25rem;">
                  <i class="fas fa-trash"></i>
                </button>
                <button class="btn btn-sm btn-success" 
                        *ngIf="canMarkAsCompleted(document)"
                        (click)="markDocumentAsCompleted(document)"
                        [disabled]="isLoading"
                        title="Marquer ce document comme complété"
                        style="border-radius: 6px; padding: 0.4rem 0.8rem; margin-right: 0.25rem;">
                  <i class="fas fa-check-circle"></i>
                  <span class="d-none d-md-inline" style="margin-left: 0.25rem;">Compléter</span>
                </button>
                <span class="badge badge-danger" 
                      *ngIf="document.status === StatutDocumentHuissier.EXPIRED"
                      title="Ce document est expiré. Il ne peut pas être marqué comme complété."
                      style="padding: 0.4rem 0.8rem; margin-right: 0.25rem;">
                  <i class="fas fa-exclamation-triangle"></i> Expiré
                </span>
                <span class="badge badge-success" 
                      *ngIf="document.status === StatutDocumentHuissier.COMPLETED"
                      title="Ce document a été marqué comme complété."
                      style="padding: 0.4rem 0.8rem; margin-right: 0.25rem;">
                  <i class="fas fa-check"></i> Complété
                </span>
                <button class="btn btn-sm btn-secondary" 
                        *ngIf="document.pieceJointeUrl"
                        (click)="openDocument(document.pieceJointeUrl!)"
                        title="Ouvrir la pièce jointe"
                        style="border-radius: 6px; padding: 0.4rem 0.8rem;">
                  <i class="fas fa-external-link-alt"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Bouton Passer aux Actions (seulement si à l'étape documents) -->
    <div class="mt-4 text-center" *ngIf="!isLoadingDocuments && documents.length > 0 && canCreateDocument(selectedDossier!)">
      <button 
        class="btn btn-success btn-lg"
        (click)="passerAuxActions()"
        [disabled]="!canPasserAuxActions() || isLoading"
        [title]="!canPasserAuxActions() ? 'Vous devez créer au moins un document' : 'Passer à l\'étape Actions'">
        <i class="fas fa-arrow-right"></i> Passer aux Actions
      </button>
      <p class="text-muted mt-2" *ngIf="documents.length === 0">
        <i class="fas fa-info-circle"></i> Créez au moins un document pour pouvoir passer aux actions
      </p>
    </div>
    <!-- Message informatif si le dossier est passé aux actions/audiences -->
    <div class="mt-4 alert alert-info" *ngIf="selectedDossier && !canCreateDocument(selectedDossier)">
      <i class="fas fa-info-circle"></i>
      <strong>Ce dossier est à l'étape "{{ getDossierEtape(selectedDossier) }}".</strong>
      Vous pouvez consulter les documents créés précédemment, mais vous ne pouvez plus en créer de nouveaux.
    </div>
  </div>

  <!-- Message si aucun dossier sélectionné -->
  <div *ngIf="!selectedDossierId" class="alert alert-warning text-center">
    <i class="fas fa-exclamation-triangle"></i>
    <strong>Veuillez sélectionner un dossier</strong> pour voir et gérer ses documents.
  </div>

  <!-- Modal de création/modification de document -->
  <div class="modal" 
       [class.show]="showDocumentForm"
       *ngIf="showDocumentForm"
       (click)="closeDocumentForm()">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            {{ isEditDocumentMode ? 'Modifier un Document Huissier' : 'Créer un Document Huissier' }}
          </h5>
          <button type="button" class="close" (click)="closeDocumentForm()">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="typeDocument">Type de Document *</label>
            <select 
              id="typeDocument"
              class="form-control"
              [(ngModel)]="documentForm.typeDocument"
              [disabled]="isLoading">
              <option [value]="TypeDocumentHuissier.PV_MISE_EN_DEMEURE">PV Mise en Demeure</option>
              <option [value]="TypeDocumentHuissier.ORDONNANCE_PAIEMENT">Ordonnance de Paiement</option>
              <option [value]="TypeDocumentHuissier.PV_NOTIFICATION_ORDONNANCE">PV Notification Ordonnance</option>
            </select>
          </div>

          <div class="form-group">
            <label for="huissierName">Nom de l'Huissier *</label>
            <input 
              type="text"
              id="huissierName"
              class="form-control"
              [(ngModel)]="documentForm.huissierName"
              [disabled]="isLoading"
              placeholder="Ex: Said ben salem">
          </div>

          <div class="form-group">
            <label for="pieceJointe">Pièce Jointe</label>
            <input 
              type="file"
              id="pieceJointe"
              class="form-control"
              (change)="onFileSelected($event)"
              [disabled]="isLoading"
              accept=".pdf,.jpg,.jpeg,.png">
            <small class="form-text text-muted">
              Formats acceptés : PDF, JPEG, PNG. Taille maximale : 10MB
            </small>
            <div *ngIf="selectedFile" class="mt-2">
              <span class="badge badge-info">
                <i class="fas fa-file"></i> {{ selectedFile.name }} ({{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB)
              </span>
            </div>
            <div *ngIf="!selectedFile && documentForm.pieceJointeUrl" class="mt-2">
              <span class="badge badge-secondary">
                <i class="fas fa-link"></i> Fichier existant : <a [href]="documentForm.pieceJointeUrl" target="_blank">Voir</a>
              </span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeDocumentForm()">
            Annuler
          </button>
          <button type="button" class="btn btn-primary" (click)="createDocument()" [disabled]="isLoading">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm mr-2"></span>
            {{ isEditDocumentMode ? 'Modifier' : 'Créer' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de visualisation de document -->
  <div class="modal" 
       [class.show]="showDocumentView"
       *ngIf="showDocumentView && selectedDocument"
       (click)="closeDocumentView()">
    <div class="modal-dialog modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-file-alt"></i> Détails du Document
          </h5>
          <button type="button" class="close" (click)="closeDocumentView()">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="document-details">
            <div class="detail-row">
              <span class="detail-label">Type de Document:</span>
              <span class="detail-value">{{ getDocumentTypeLabel(selectedDocument.typeDocument) }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Date de Création:</span>
              <span class="detail-value">{{ formatDate(selectedDocument.dateCreation) }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Délai Légal:</span>
              <span class="detail-value">{{ selectedDocument.delaiLegalDays }} jours</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Date d'Expiration:</span>
              <span class="detail-value">{{ getExpirationDate(selectedDocument) }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Statut:</span>
              <span class="detail-value">
                <span class="badge" 
                      [class.badge-warning]="selectedDocument.status === StatutDocumentHuissier.PENDING"
                      [class.badge-danger]="selectedDocument.status === StatutDocumentHuissier.EXPIRED"
                      [class.badge-success]="selectedDocument.status === StatutDocumentHuissier.COMPLETED">
                  {{ getStatusLabel(selectedDocument.status) }}
                </span>
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Huissier:</span>
              <span class="detail-value">{{ selectedDocument.huissierName }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedDocument.pieceJointeUrl">
              <span class="detail-label">Pièce Jointe:</span>
              <span class="detail-value">
                <button class="btn btn-sm btn-info" (click)="openDocument(selectedDocument.pieceJointeUrl!)">
                  <i class="fas fa-external-link-alt"></i> Ouvrir
                </button>
              </span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeDocumentView()">
            Fermer
          </button>
          <button type="button" class="btn btn-warning" (click)="openDocumentForm(selectedDocument); closeDocumentView()">
            <i class="fas fa-edit"></i> Modifier
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

