<div class="gestion-actions-container">
  <!-- En-tête -->
  <div class="header">
    <h1>
      <mat-icon>work</mat-icon>
      Gestion des Actions - Recouvrement Amiable
    </h1>
    <p>Gérez les dossiers et actions du département de recouvrement amiable</p>
  </div>

  <!-- Onglets -->
  <mat-tab-group [(selectedIndex)]="selectedTab" (selectedIndexChange)="onTabChange($event)" class="main-tabs">
    <!-- Onglet 1: Liste des Dossiers -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>{{ tabs[0].icon }}</mat-icon>
        {{ tabs[0].label }}
      </ng-template>
      
      <div class="tab-content">
        <!-- Zone de recherche -->
        <mat-card class="search-card">
          <mat-card-content>
            <div class="search-section">
              <div class="search-form">
                <div class="form-group">
                  <label for="numeroDossier">Rechercher un dossier :</label>
                  <input 
                    type="text" 
                    id="numeroDossier"
                    [(ngModel)]="searchTerm" 
                    (input)="onSearchChange(searchTerm)"
                    placeholder="Rechercher par numéro, créancier ou débiteur..."
                    class="form-control">
                  <small class="form-text text-muted">La recherche se fait automatiquement après 300ms</small>
                </div>
                <div class="form-actions">
                  <button mat-raised-button color="primary" (click)="rechercherDossier()">
                    <mat-icon>search</mat-icon>
                    Rechercher
                  </button>
                  <button mat-icon-button (click)="loadDossiers()" [disabled]="loading" matTooltip="Actualiser">
                    <mat-icon [class.spinning]="loading">refresh</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Liste des dossiers -->
        <div class="dossiers-section">
          <h2>Historique Complet des Dossiers</h2>
          <p class="section-subtitle">Tous les dossiers avec leurs actions (y compris ceux affectés au recouvrement juridique)</p>
          
          <div *ngIf="loading" class="loading-container">
            <mat-spinner diameter="50"></mat-spinner>
            <p>Chargement des dossiers...</p>
          </div>
          
          <div *ngIf="!loading && dossiers.length === 0" class="no-dossiers">
            <mat-icon>folder_open</mat-icon>
            <p>Aucun dossier trouvé pour le moment.</p>
          </div>
          
          <div class="dossiers-grid" *ngIf="!loading && dossiers.length > 0">
            <mat-card 
              class="dossier-card" 
              *ngFor="let dossier of dossiers"
              [attr.data-dossier-id]="dossier.id"
              [class.selected]="dossierSelectionne?.numeroDossier === dossier.numeroDossier"
              (click)="selectionnerDossier(dossier)">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>folder</mat-icon>
                  {{ dossier.numeroDossier }}
                  <mat-chip *ngIf="dossier.affecteAuJuridique" color="accent" class="juridique-badge">
                    <mat-icon>gavel</mat-icon>
                    Juridique
                  </mat-chip>
                </mat-card-title>
                <mat-card-subtitle>
                  <mat-chip *ngIf="getActionsCount(dossier.id) > 0" color="primary">
                    <mat-icon>history</mat-icon>
                    {{ getActionsCount(dossier.id) }} action(s)
                  </mat-chip>
                  <mat-chip *ngIf="dossier.statut" [color]="dossier.statut === 'CLOTURE' ? 'warn' : 'primary'">
                    {{ dossier.statut }}
                  </mat-chip>
                  <mat-chip *ngIf="isDossierFinalise(dossier)" color="primary" class="finalise-badge">
                    <mat-icon>check_circle</mat-icon>
                    Finalisé
                  </mat-chip>
                </mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <div class="dossier-info">
                  <p><strong>Créancier:</strong> {{ dossier.nomCreancier }}</p>
                  <p><strong>Débiteur:</strong> {{ dossier.nomDebiteur }}</p>
                </div>
              </mat-card-content>
              <mat-card-actions *ngIf="dossierSelectionne?.numeroDossier === dossier.numeroDossier && !dossier.affecteAuJuridique && !isDossierFinalise(dossier)" class="dossier-actions-quick">
                <button 
                  mat-raised-button 
                  color="accent" 
                  (click)="affecterAuJuridique(); $event.stopPropagation()"
                  [disabled]="loading || isDossierJuridique()"
                  [matTooltip]="isDossierJuridique() ? 'Ce dossier est déjà affecté au recouvrement juridique' : 'Affecter ce dossier au recouvrement juridique'">
                  <mat-icon>gavel</mat-icon>
                  Affecter au Juridique
                </button>
                <button 
                  *ngIf="canFinaliserDossierAmiable(dossier)"
                  mat-raised-button 
                  color="warn" 
                  (click)="openFinalisationForm(); $event.stopPropagation()"
                  [disabled]="loading"
                  [matTooltip]="'Finaliser le dossier amiable avec l\'état final et le montant recouvré'">
                  <mat-icon>check_circle</mat-icon>
                  Finaliser
                </button>
              </mat-card-actions>
              <mat-card-actions *ngIf="dossierSelectionne?.numeroDossier === dossier.numeroDossier && dossier.affecteAuJuridique" class="dossier-actions-quick">
                <p class="info-message">
                  <mat-icon>info</mat-icon>
                  Ce dossier a été affecté au recouvrement juridique. Vous pouvez toujours consulter l'historique des actions.
                </p>
              </mat-card-actions>
              <mat-card-actions *ngIf="dossierSelectionne?.numeroDossier === dossier.numeroDossier && isDossierFinalise(dossier)" class="dossier-actions-quick">
                <p class="info-message finalise-message">
                  <mat-icon>check_circle</mat-icon>
                  Ce dossier est finalisé. Consultation seule.
                </p>
              </mat-card-actions>
            </mat-card>
          </div>
        </div>
      </div>
    </mat-tab>

    <!-- Onglet 2: Actions -->
    <mat-tab [disabled]="tabs[1].disabled">
      <ng-template mat-tab-label>
        <mat-icon [matBadge]="dossierSelectionne && getActionsCount(dossierSelectionne.id) > 0 ? getActionsCount(dossierSelectionne.id) : null" 
                  matBadgeOverlap="false">{{ tabs[1].icon }}</mat-icon>
        {{ tabs[1].label }}
      </ng-template>
      
      <div class="tab-content" *ngIf="dossierSelectionne && dossierSelectionne.id">
        <app-dossier-actions-amiable 
          [dossierId]="dossierSelectionne.id"
          [typeRecouvrement]="dossierSelectionne.typeRecouvrement"
          (actionCreated)="recalculatePredictionAfterAction()"
          (actionUpdated)="recalculatePredictionAfterAction()">
        </app-dossier-actions-amiable>
      </div>
      
      <div class="no-selection" *ngIf="!dossierSelectionne">
        <mat-icon>info</mat-icon>
        <p>Sélectionnez un dossier dans l'onglet "Liste des Dossiers" pour voir ses actions</p>
      </div>
    </mat-tab>

    <!-- Onglet 3: Détails -->
    <mat-tab [disabled]="tabs[2].disabled">
      <ng-template mat-tab-label>
        <mat-icon>{{ tabs[2].icon }}</mat-icon>
        {{ tabs[2].label }}
      </ng-template>
      
      <div class="tab-content" *ngIf="dossierSelectionne">
        <mat-card class="details-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>folder</mat-icon>
              Dossier: {{ dossierSelectionne.numeroDossier }}
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="dossier-details-grid">
              <div class="detail-item">
                <mat-icon>person</mat-icon>
                <div>
                  <strong>Créancier:</strong>
                  <p>{{ dossierSelectionne.nomCreancier }}</p>
                </div>
              </div>
              <div class="detail-item">
                <mat-icon>person_outline</mat-icon>
                <div>
                  <strong>Débiteur:</strong>
                  <p>{{ dossierSelectionne.nomDebiteur }}</p>
                </div>
              </div>
            </div>
            
            <div class="dossier-actions-section" *ngIf="dossierApiSelectionne">
              <h3>
                <mat-icon>info</mat-icon>
                Informations Complémentaires
              </h3>
              <div class="info-grid">
                <div class="info-item" *ngIf="dossierApiSelectionne.montantCreance">
                  <strong>Montant total:</strong>
                  <span class="value-amount">{{ dossierApiSelectionne.montantCreance | number:'1.2-2' }} TND</span>
                </div>
                <div class="info-item" *ngIf="getMontantRecouvre() !== null">
                  <strong>Montant recouvré:</strong>
                  <span class="value-amount success">{{ getMontantRecouvre() | number:'1.2-2' }} TND</span>
                </div>
                <div class="info-item" *ngIf="getMontantRestant() !== null">
                  <strong>Montant restant:</strong>
                  <span class="value-amount" [class.warning]="getMontantRestant()! > 0" [class.success]="getMontantRestant() === 0">
                    {{ getMontantRestant() | number:'1.2-2' }} TND
                  </span>
                </div>
                <div class="info-item" *ngIf="dossierApiSelectionne.dateCreation">
                  <strong>Date de création:</strong>
                  <span>{{ dossierApiSelectionne.dateCreation | date:'dd/MM/yyyy' }}</span>
                </div>
                <div class="info-item" *ngIf="dossierApiSelectionne.urgence">
                  <strong>Urgence:</strong>
                  <mat-chip [class]="'chip-' + dossierApiSelectionne.urgence.toLowerCase()">
                    {{ dossierApiSelectionne.urgence }}
                  </mat-chip>
                </div>
                <div class="info-item" *ngIf="getActionsCount(dossierSelectionne.id) > 0">
                  <strong>Nombre d'actions:</strong>
                  <span>{{ getActionsCount(dossierSelectionne.id) }}</span>
                </div>
                <div class="info-item" *ngIf="dossierApiSelectionne?.typeRecouvrement">
                  <strong>Type de recouvrement:</strong>
                  <mat-chip [class]="'chip-' + (dossierApiSelectionne.typeRecouvrement?.toLowerCase() || '')">
                    <mat-icon *ngIf="dossierApiSelectionne.typeRecouvrement === 'JURIDIQUE'">gavel</mat-icon>
                    <mat-icon *ngIf="dossierApiSelectionne.typeRecouvrement === 'AMIABLE'">handshake</mat-icon>
                    <mat-icon *ngIf="dossierApiSelectionne.typeRecouvrement === 'NON_AFFECTE'">help</mat-icon>
                    {{ getTypeRecouvrementLabel(dossierApiSelectionne.typeRecouvrement) }}
                  </mat-chip>
                </div>
                <!-- Prédiction IA -->
                <div class="info-item prediction-item">
                  <strong>Prédiction IA:</strong>
                  <div class="prediction-content">
                    <app-ia-prediction-badge
                      [prediction]="getPrediction()"
                      [loading]="loadingPrediction"
                      [showDetails]="true"
                      size="medium"
                    ></app-ia-prediction-badge>
                    <button 
                      *ngIf="!getPrediction() && !loadingPrediction"
                      mat-icon-button
                      color="primary"
                      (click)="triggerPrediction()"
                      matTooltip="Calculer Prédiction IA">
                      <mat-icon>psychology</mat-icon>
                    </button>
                    <button 
                      *ngIf="getPrediction() && !loadingPrediction"
                      mat-icon-button
                      color="accent"
                      (click)="triggerPrediction()"
                      matTooltip="Recalculer Prédiction IA">
                      <mat-icon>refresh</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Section Actions -->
            <div class="actions-section" *ngIf="dossierSelectionne && dossierSelectionne.actions && dossierSelectionne.actions.length > 0">
              <h3>
                <mat-icon>history</mat-icon>
                Actions de Recouvrement
              </h3>
              <div class="actions-list">
                <div class="action-item" *ngFor="let action of dossierSelectionne.actions | slice:0:5">
                  <div class="action-header">
                    <mat-icon>{{ getActionIcon(action.type) }}</mat-icon>
                    <div class="action-info">
                      <strong>{{ getActionTypeLabel(action.type) }}</strong>
                      <span class="action-date">{{ action.dateAction | date:'dd/MM/yyyy' }}</span>
                    </div>
                    <mat-chip *ngIf="action.reponseDebiteur" [class]="'chip-' + action.reponseDebiteur.toLowerCase()">
                      {{ action.reponseDebiteur }}
                    </mat-chip>
                  </div>
                  <div class="action-details" *ngIf="action.nbOccurrences || action.coutUnitaire">
                    <span *ngIf="action.nbOccurrences">{{ action.nbOccurrences }} occurrence(s)</span>
                    <span *ngIf="action.coutUnitaire"> - Coût: {{ action.coutUnitaire | number:'1.2-2' }} TND</span>
                  </div>
                </div>
                <div *ngIf="dossierSelectionne.actions.length > 5" class="more-actions">
                  <p>Et {{ dossierSelectionne.actions.length - 5 }} autre(s) action(s)...</p>
                </div>
              </div>
            </div>
          </mat-card-content>
          <mat-card-actions *ngIf="!isDossierFinalise(dossierSelectionne)">
            <button 
              mat-raised-button 
              color="accent" 
              (click)="affecterAuJuridique()" 
              [disabled]="loading || isDossierJuridique()"
              [matTooltip]="isDossierJuridique() ? 'Ce dossier est déjà affecté au recouvrement juridique' : ''">
              <mat-icon>gavel</mat-icon>
              Affecter au Juridique
            </button>
            <button 
              *ngIf="canFinaliserDossierAmiable(dossierSelectionne)"
              mat-raised-button 
              color="warn" 
              (click)="openFinalisationForm()"
              [disabled]="loading"
              matTooltip="Finaliser le dossier amiable avec l'état final et le montant recouvré">
              <mat-icon>check_circle</mat-icon>
              Finaliser
            </button>
          </mat-card-actions>
          <mat-card-actions *ngIf="isDossierFinalise(dossierSelectionne)">
            <p class="info-message finalise-message">
              <mat-icon>check_circle</mat-icon>
              Ce dossier est finalisé. Consultation seule.
            </p>
          </mat-card-actions>
        </mat-card>
      </div>
      
      <div class="no-selection" *ngIf="!dossierSelectionne">
        <mat-icon>info</mat-icon>
        <p>Sélectionnez un dossier pour voir ses détails</p>
      </div>
    </mat-tab>

    <!-- Onglet 4: Recommandations -->
    <mat-tab [disabled]="tabs[3].disabled">
      <ng-template mat-tab-label>
        <mat-icon>{{ tabs[3].icon }}</mat-icon>
        {{ tabs[3].label }}
      </ng-template>
      
      <div class="tab-content" *ngIf="dossierSelectionne && dossierSelectionne.id">
        <app-dossier-recommandations [dossierId]="dossierSelectionne.id"></app-dossier-recommandations>
      </div>
      
      <div class="no-selection" *ngIf="!dossierSelectionne">
        <mat-icon>info</mat-icon>
        <p>Sélectionnez un dossier pour voir les recommandations</p>
      </div>
    </mat-tab>
  </mat-tab-group>

  <!-- Modal de Finalisation du Dossier Amiable -->
  <div class="modal-overlay" *ngIf="showFinalisationForm" (click)="closeFinalisationForm()">
    <div class="modal-content finalisation-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <mat-icon>check_circle</mat-icon>
          Finaliser le Dossier Amiable
        </h2>
        <button class="close-btn" (click)="closeFinalisationForm()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="modal-body">
        <div class="dossier-info-finalisation" *ngIf="selectedDossierForFinalisation">
          <div class="info-section">
            <h3>Informations du Dossier</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="label">Numéro:</span>
                <span class="value">{{ selectedDossierForFinalisation.numeroDossier || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <span class="label">Créancier:</span>
                <span class="value">{{ selectedDossierForFinalisation.creancier?.nom || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <span class="label">Montant Créance:</span>
                <span class="value amount">{{ selectedDossierForFinalisation.montantCreance || 0 | number:'1.2-2' }} TND</span>
              </div>
              <div class="info-item">
                <span class="label">Nombre d'Actions:</span>
                <span class="value">{{ getActionsCount(selectedDossierForFinalisation.id) }}</span>
              </div>
            </div>
          </div>
        </div>

        <form [formGroup]="finalisationForm" (ngSubmit)="finaliserDossierAmiable()">
          <div class="form-section">
            <h3>État Final du Dossier</h3>
            <p class="form-description">Sélectionnez l'état final du dossier après les actions amiable :</p>
            
            <div class="etat-buttons">
              <button 
                type="button"
                class="btn-etat btn-total"
                [class.active]="finalisationForm.get('etatFinal')?.value === etatFinalDossier.RECOUVREMENT_TOTAL"
                (click)="setEtatFinal(etatFinalDossier.RECOUVREMENT_TOTAL)">
                <mat-icon>check_circle</mat-icon>
                <span>Recouvrement Total</span>
              </button>
              <button 
                type="button"
                class="btn-etat btn-partiel"
                [class.active]="finalisationForm.get('etatFinal')?.value === etatFinalDossier.RECOUVREMENT_PARTIEL"
                (click)="setEtatFinal(etatFinalDossier.RECOUVREMENT_PARTIEL)">
                <mat-icon>percent</mat-icon>
                <span>Recouvrement Partiel</span>
              </button>
              <button 
                type="button"
                class="btn-etat btn-non-recouvre"
                [class.active]="finalisationForm.get('etatFinal')?.value === etatFinalDossier.NON_RECOUVRE"
                (click)="setEtatFinal(etatFinalDossier.NON_RECOUVRE)">
                <mat-icon>cancel</mat-icon>
                <span>Non Recouvré</span>
              </button>
            </div>
            
            <div class="form-group" *ngIf="finalisationForm.get('etatFinal')?.value">
              <label>
                <mat-icon>info</mat-icon>
                État sélectionné: <strong>{{ getEtatFinalLabel(finalisationForm.get('etatFinal')?.value) }}</strong>
              </label>
              <input type="hidden" formControlName="etatFinal">
            </div>
          </div>

          <div class="form-section" *ngIf="shouldShowMontantRecouvre()">
            <h3>Montant Recouvré</h3>
            <p class="form-description">Indiquez le montant recouvré dans cette étape amiable :</p>
            
            <div class="form-group">
              <label for="montantRecouvre">
                <mat-icon>attach_money</mat-icon>
                Montant Recouvré (TND)
              </label>
              <input 
                type="number" 
                id="montantRecouvre"
                formControlName="montantRecouvre"
                class="form-control"
                [readonly]="isMontantRecouvreReadOnly()"
                [class.readonly]="isMontantRecouvreReadOnly()"
                min="0"
                step="0.01"
                placeholder="0.00">
              <div class="form-hint" *ngIf="selectedDossierForFinalisation">
                Montant de la créance: <strong>{{ selectedDossierForFinalisation.montantCreance || 0 | number:'1.2-2' }} TND</strong>
              </div>
              <div class="form-hint" *ngIf="selectedDossierForFinalisation && getMontantRestantFinalisation() >= 0">
                Montant restant: <strong>{{ getMontantRestantFinalisation() | number:'1.2-2' }} TND</strong>
              </div>
              <div class="form-error" *ngIf="finalisationForm.get('montantRecouvre')?.invalid && finalisationForm.get('montantRecouvre')?.touched">
                <span *ngIf="finalisationForm.get('montantRecouvre')?.errors?.['required']">Le montant recouvré est obligatoire</span>
                <span *ngIf="finalisationForm.get('montantRecouvre')?.errors?.['min']">Le montant doit être positif</span>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" mat-button (click)="closeFinalisationForm()" [disabled]="isLoadingFinalisation">
              <mat-icon>close</mat-icon>
              Annuler
            </button>
            <button type="submit" mat-raised-button color="primary" [disabled]="finalisationForm.invalid || isLoadingFinalisation">
              <mat-icon *ngIf="!isLoadingFinalisation">check_circle</mat-icon>
              <mat-spinner *ngIf="isLoadingFinalisation" diameter="20"></mat-spinner>
              {{ isLoadingFinalisation ? 'Finalisation...' : 'Finaliser le Dossier' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
