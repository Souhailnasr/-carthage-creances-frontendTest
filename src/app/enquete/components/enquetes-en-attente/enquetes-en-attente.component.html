<div class="enquetes-en-attente-container">
  <div class="page-header">
    <h1>
      <mat-icon>pending_actions</mat-icon>
      Enquêtes en attente de validation
    </h1>
    <p class="subtitle">Gérez les enquêtes créées par les agents en attente de validation</p>
    <div class="header-actions">
      <button mat-icon-button (click)="loadEnquetesEnAttente()" [disabled]="loading" matTooltip="Rafraîchir">
        <mat-icon>refresh</mat-icon>
      </button>
      <button mat-icon-button (click)="toggleAutoRefresh()" [color]="autoRefreshEnabled ? 'primary' : ''" matTooltip="Auto-rafraîchissement">
        <mat-icon>{{ autoRefreshEnabled ? 'sync' : 'sync_disabled' }}</mat-icon>
      </button>
    </div>
  </div>

  <div class="table-container" *ngIf="!loading && dataSource.data.length > 0">
    <table mat-table [dataSource]="dataSource" class="mat-elevation-z2">
      <!-- Code rapport Column -->
      <ng-container matColumnDef="rapportCode">
        <th mat-header-cell *matHeaderCellDef>Code rapport</th>
        <td mat-cell *matCellDef="let validation">
          {{ validation.enquete?.rapportCode || 'N/A' }}
        </td>
      </ng-container>

      <!-- Dossier Column -->
      <ng-container matColumnDef="dossier">
        <th mat-header-cell *matHeaderCellDef>Dossier</th>
        <td mat-cell *matCellDef="let validation">
          {{ getDossierInfo(validation) }}
        </td>
      </ng-container>

      <!-- Agent créateur Column -->
      <ng-container matColumnDef="agentCreateur">
        <th mat-header-cell *matHeaderCellDef>Agent créateur</th>
        <td mat-cell *matCellDef="let validation">
          {{ getAgentName(validation) }}
        </td>
      </ng-container>

      <!-- Date création Column -->
      <ng-container matColumnDef="dateCreation">
        <th mat-header-cell *matHeaderCellDef>Date création validation</th>
        <td mat-cell *matCellDef="let validation">
          {{ formatDate(validation.dateCreation) }}
        </td>
      </ng-container>

      <!-- Statut Column -->
      <ng-container matColumnDef="statut">
        <th mat-header-cell *matHeaderCellDef>Statut</th>
        <td mat-cell *matCellDef="let validation">
          <mat-chip [color]="getStatutColor(validation.statut)">
            {{ getStatutLabel(validation.statut) }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let validation">
          <button 
            mat-icon-button 
            color="primary" 
            (click)="validerEnquete(validation)" 
            *ngIf="canValidate() && validation.statut === StatutValidation.EN_ATTENTE"
            matTooltip="Valider">
            <mat-icon>check_circle</mat-icon>
          </button>
          <button 
            mat-icon-button 
            color="warn" 
            (click)="rejeterEnquete(validation)" 
            *ngIf="canValidate() && validation.statut === StatutValidation.EN_ATTENTE"
            matTooltip="Rejeter">
            <mat-icon>cancel</mat-icon>
          </button>
          <button mat-icon-button (click)="voirDetails(validation)" matTooltip="Voir détails">
            <mat-icon>visibility</mat-icon>
          </button>
          <button mat-icon-button (click)="voirHistorique(validation)" matTooltip="Voir historique">
            <mat-icon>history</mat-icon>
          </button>
          <button 
            mat-icon-button 
            color="warn" 
            (click)="confirmDeleteEnquete(validation)" 
            *ngIf="canDelete(validation)"
            [disabled]="isDeleting(validation.enquete?.id)"
            matTooltip="Supprimer l'enquête">
            <mat-icon *ngIf="!isDeleting(validation.enquete?.id)">delete</mat-icon>
            <mat-spinner *ngIf="isDeleting(validation.enquete?.id)" diameter="20"></mat-spinner>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <mat-paginator [pageSizeOptions]="[5, 10, 20, 50]" showFirstLastButtons></mat-paginator>
  </div>

  <div class="loading-container" *ngIf="loading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Chargement des enquêtes en attente...</p>
  </div>

  <div class="empty-container" *ngIf="!loading && dataSource.data.length === 0">
    <mat-icon>inbox</mat-icon>
    <p>Aucune enquête en attente de validation</p>
  </div>
</div>

