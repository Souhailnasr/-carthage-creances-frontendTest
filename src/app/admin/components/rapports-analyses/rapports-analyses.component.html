<div class="rapports-analyses">
  <div class="header">
    <div class="header-content">
      <h1><i class="fas fa-chart-bar"></i> Rapports & Analyses</h1>
      <p class="subtitle">Analyses consolidées et comparaisons entre départements</p>
    </div>
    <button class="btn btn-primary" (click)="loadData()">
      <i class="fas fa-sync-alt"></i> Actualiser
    </button>
  </div>

  <div *ngIf="loading" class="loading-container">
    <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
    <p>Chargement des rapports...</p>
  </div>

  <!-- KPIs -->
  <div class="kpis-section" *ngIf="!loading && kpis">
    <h2><i class="fas fa-tachometer-alt"></i> Indicateurs Clés de Performance</h2>
    <div class="kpis-grid">
      <mat-card class="kpi-card">
        <h3>Total Créances en Cours</h3>
        <div class="kpi-value">{{ formatAmount(kpis.totalCreancesEnCours.montant) }}</div>
        <div class="kpi-trend" [class]="'trend-' + kpis.totalCreancesEnCours.tendance">
          <i class="fas" [class.fa-arrow-up]="kpis.totalCreancesEnCours.tendance === 'up'"
                     [class.fa-arrow-down]="kpis.totalCreancesEnCours.tendance === 'down'"
                     [class.fa-minus]="kpis.totalCreancesEnCours.tendance === 'stable'"></i>
          {{ kpis.totalCreancesEnCours.variationMoisPrecedent > 0 ? '+' : '' }}{{ kpis.totalCreancesEnCours.variationMoisPrecedent }}%
        </div>
      </mat-card>

      <mat-card class="kpi-card">
        <h3>Taux de Recouvrement Global</h3>
        <div class="kpi-value">{{ kpis.tauxRecouvrementGlobal.pourcentage.toFixed(1) }}%</div>
        <div class="kpi-objectif">Objectif: {{ kpis.tauxRecouvrementGlobal.objectif }}%</div>
        <div class="kpi-performance" [class]="'perf-' + kpis.tauxRecouvrementGlobal.performance">
          {{ kpis.tauxRecouvrementGlobal.performance }}
        </div>
      </mat-card>

      <mat-card class="kpi-card">
        <h3>Dossiers en Retard</h3>
        <div class="retard-stats">
          <div class="retard-item">
            <span>>30j:</span> <strong>{{ kpis.dossiersEnRetard.plus30j }}</strong>
          </div>
          <div class="retard-item">
            <span>>60j:</span> <strong class="warning">{{ kpis.dossiersEnRetard.plus60j }}</strong>
          </div>
          <div class="retard-item">
            <span>>90j:</span> <strong class="danger">{{ kpis.dossiersEnRetard.plus90j }}</strong>
          </div>
        </div>
      </mat-card>

      <mat-card class="kpi-card">
        <h3>Agents Actifs</h3>
        <div class="kpi-value">{{ kpis.agentsActifs.actifs }} / {{ kpis.agentsActifs.total }}</div>
        <div class="kpi-taux">{{ kpis.agentsActifs.tauxActivite.toFixed(1) }}% d'activité</div>
      </mat-card>
    </div>
  </div>

  <!-- Graphiques -->
  <div class="charts-section" *ngIf="!loading">
    <h2><i class="fas fa-chart-line"></i> Analyses et Graphiques</h2>
    <div class="charts-grid">
      <!-- Évolution mensuelle -->
      <mat-card class="chart-card" *ngIf="evolutionChartData">
        <mat-card-header>
          <mat-card-title>Évolution Mensuelle du Recouvrement</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <app-chart type="line" [data]="evolutionChartData" [options]="{
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: true, position: 'top' },
                tooltip: { mode: 'index', intersect: false }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }"></app-chart>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Répartition par statut -->
      <mat-card class="chart-card" *ngIf="repartitionChartData">
        <mat-card-header>
          <mat-card-title>Répartition par Statut</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <app-chart type="pie" [data]="repartitionChartData" [options]="{
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: true, position: 'right' },
                tooltip: { enabled: true }
              }
            }"></app-chart>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Performance par département -->
      <mat-card class="chart-card" *ngIf="performanceChartData">
        <mat-card-header>
          <mat-card-title>Performance par Département</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <app-chart type="bar" [data]="performanceChartData" [options]="{
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: true, position: 'top' },
                tooltip: { mode: 'index', intersect: false }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }"></app-chart>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>

