<div class="user-management-container">
  <div class="header">
    <h1>Gestion des Utilisateurs</h1>
    <button class="btn btn-primary" (click)="showCreateUserForm()">
      <i class="fas fa-user-plus"></i> Ajouter un Utilisateur
    </button>
  </div>

  <!-- Formulaire de création/édition -->
  <div class="form-container" *ngIf="showCreateForm">
    <div class="form-header">
      <h2>{{ isEditMode ? 'Modifier l\'Utilisateur' : 'Nouvel Utilisateur' }}</h2>
      <button class="btn btn-secondary" (click)="cancelForm()">
        <i class="fas fa-times"></i> Annuler
      </button>
    </div>

    <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="user-form">
      <div class="form-grid">
        <app-form-input label="Nom" [control]="nomControl" id="nom"></app-form-input>
        <app-form-input label="Prénom" [control]="prenomControl" id="prenom"></app-form-input>
        <app-form-input label="Email" [control]="emailControl" type="email" id="email"></app-form-input>
        
        <!-- Mot de passe avec visibilité -->
        <div class="form-group password-group">
          <label for="motDePasse">Mot de passe</label>
          <div class="password-input-wrapper">
            <input 
              [type]="getPasswordFieldType()" 
              id="motDePasse" 
              formControlName="motDePasse"
              class="form-control"
              [class.is-invalid]="motDePasseControl.invalid && motDePasseControl.touched"
              placeholder="Entrez le mot de passe">
            <button type="button" class="password-toggle" (click)="togglePasswordVisibility()">
              <i class="fas" [class.fa-eye]="!showPassword" [class.fa-eye-slash]="showPassword"></i>
            </button>
          </div>
          <div class="invalid-feedback" *ngIf="motDePasseControl.invalid && motDePasseControl.touched">
            <div *ngIf="motDePasseControl.errors?.['required']">Le mot de passe est requis</div>
            <div *ngIf="motDePasseControl.errors?.['minlength']">Le mot de passe doit contenir au moins 6 caractères</div>
          </div>
        </div>

        <!-- Confirmation mot de passe -->
        <div class="form-group password-group">
          <label for="confirmPassword">Confirmer le mot de passe</label>
          <div class="password-input-wrapper">
            <input 
              [type]="getConfirmPasswordFieldType()" 
              id="confirmPassword" 
              formControlName="confirmPassword"
              class="form-control"
              [class.is-invalid]="confirmPasswordControl.invalid && confirmPasswordControl.touched"
              placeholder="Confirmez le mot de passe">
            <button type="button" class="password-toggle" (click)="toggleConfirmPasswordVisibility()">
              <i class="fas" [class.fa-eye]="!showConfirmPassword" [class.fa-eye-slash]="showConfirmPassword"></i>
            </button>
          </div>
          <div class="invalid-feedback" *ngIf="confirmPasswordControl.invalid && confirmPasswordControl.touched">
            <div *ngIf="confirmPasswordControl.errors?.['required']">La confirmation du mot de passe est requise</div>
            <div *ngIf="confirmPasswordControl.errors?.['passwordMismatch']">Les mots de passe ne correspondent pas</div>
          </div>
        </div>

        <!-- Rôle -->
        <div class="form-group">
          <label for="role">Rôle</label>
          <select id="role" formControlName="role" class="form-control" 
                  [class.is-invalid]="roleControl.invalid && roleControl.touched">
            <option value="">Sélectionnez un rôle</option>
            <option *ngFor="let role of getAvailableRoles()" [value]="role">
              {{ getRoleDisplayName(role) }}
            </option>
          </select>
          <div class="invalid-feedback" *ngIf="roleControl.invalid && roleControl.touched">
            Le rôle est requis
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="cancelForm()">Annuler</button>
        <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid">
          {{ isEditMode ? 'Mettre à jour' : 'Créer' }}
        </button>
      </div>
    </form>
  </div>

  <!-- Barre de recherche et filtres -->
  <div class="search-container">
    <!-- En-tête de recherche -->
    <div class="search-header">
      <h2 class="search-title">
        <i class="fas fa-search"></i>
        Recherche et Filtres
      </h2>
      <p class="search-description">
        Trouvez rapidement les utilisateurs avec les filtres avancés
      </p>
    </div>

    <!-- Recherche rapide -->
    <div class="quick-search-row">
      <div class="search-input-wrapper">
        <i class="fas fa-search search-icon"></i>
        <input 
          type="text" 
          [(ngModel)]="searchTerm" 
          (input)="onSearch()"
          [placeholder]="getSearchPlaceholder()"
          class="search-input">
      </div>
      
      <div class="search-type-selector">
        <select id="searchType" [(ngModel)]="searchType" (change)="onSearchTypeChange()" class="form-control">
          <option value="all">Tout</option>
          <option value="name">Nom/Prénom</option>
          <option value="email">Email</option>
          <option value="role">Rôle</option>
          <option value="department">Département</option>
        </select>
      </div>

      <button class="btn btn-outline-secondary" (click)="toggleAdvancedFilters()">
        <i class="fas fa-filter"></i>
        Filtres avancés
        <span class="filter-badge" *ngIf="getActiveFiltersCount() > 0">{{ getActiveFiltersCount() }}</span>
      </button>

      <button class="btn btn-outline-danger" (click)="clearAllFilters()" *ngIf="getActiveFiltersCount() > 0">
        <i class="fas fa-times"></i>
        Effacer tout
      </button>
    </div>

    <!-- Filtres avancés -->
    <div class="advanced-filters" *ngIf="showAdvancedFilters">
      <div class="advanced-filters-header">
        <h3 class="advanced-filters-title">
          <i class="fas fa-sliders-h"></i>
          Filtres Avancés
        </h3>
        <p class="advanced-filters-description">
          Affinez votre recherche avec des critères spécifiques
        </p>
      </div>
      
      <div class="filters-grid">
        <!-- Filtre par rôle -->
        <div class="filter-group">
          <label for="roleFilter">Rôle:</label>
          <select id="roleFilter" [(ngModel)]="selectedRole" (change)="onRoleFilterChange()" class="form-control">
            <option value="">Tous les rôles</option>
            <option *ngFor="let role of getAvailableRolesForFilter().slice(1)" [value]="role">
              {{ getRoleDisplayName(role) }}
            </option>
          </select>
        </div>

        <!-- Filtre par département -->
        <div class="filter-group">
          <label for="departmentFilter">Département:</label>
          <select id="departmentFilter" [(ngModel)]="selectedDepartment" (change)="onDepartmentFilterChange()" class="form-control">
            <option *ngFor="let dept of getAvailableDepartments()" [value]="dept">
              {{ getDepartmentDisplayName(dept) }}
            </option>
          </select>
        </div>

        <!-- Filtre par statut -->
        <div class="filter-group">
          <label for="statusFilter">Statut:</label>
          <select id="statusFilter" [(ngModel)]="selectedStatus" (change)="onStatusFilterChange()" class="form-control">
            <option value="">Tous les statuts</option>
            <option value="active">Actifs</option>
            <option value="inactive">Inactifs</option>
          </select>
        </div>

        <!-- Tri -->
        <div class="filter-group">
          <label for="sortBy">Trier par:</label>
          <select id="sortBy" [(ngModel)]="sortBy" (change)="onSortChange()" class="form-control">
            <option value="name">Nom</option>
            <option value="email">Email</option>
            <option value="role">Rôle</option>
            <option value="department">Département</option>
            <option value="date">Date de création</option>
            <option value="status">Statut</option>
          </select>
        </div>

        <!-- Ordre de tri -->
        <div class="filter-group">
          <label for="sortOrder">Ordre:</label>
          <select id="sortOrder" [(ngModel)]="sortOrder" (change)="onSortOrderChange()" class="form-control">
            <option value="asc">Croissant</option>
            <option value="desc">Décroissant</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Statistiques des résultats -->
    <div class="search-stats">
      <span class="results-count">
        <i class="fas fa-users"></i>
        {{ getFilteredUsersCount() }} utilisateur(s) trouvé(s)
        <span *ngIf="getActiveFiltersCount() > 0">sur {{ utilisateurs.length }} total</span>
      </span>
    </div>
  </div>

  <!-- Liste des utilisateurs -->
  <div class="users-list">
    <div class="loading-spinner" *ngIf="isLoading">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Chargement des utilisateurs...</p>
    </div>
    
    <div class="users-grid" *ngIf="!isLoading && filteredUtilisateurs.length > 0; else noUsers">
      <div class="user-card" *ngFor="let utilisateur of filteredUtilisateurs">
        <div class="user-avatar">
          <span class="avatar-text">{{ getUserInitials(utilisateur) }}</span>
        </div>
        <div class="user-info">
          <h3 class="user-name">{{ utilisateur.prenom }} {{ utilisateur.nom }}</h3>
          <p class="user-email">{{ utilisateur.email }}</p>
          <span class="user-role" [class]="getRoleClass(utilisateur)">
            {{ getRoleDisplayName(utilisateur.roleUtilisateur || utilisateur.role || '') }}
          </span>
          <p class="user-department" *ngIf="utilisateur.departement">
            <i class="fas fa-building"></i> {{ getDepartmentDisplayName(utilisateur.departement) }}
          </p>
        </div>
        <div class="user-actions">
          <button class="btn btn-sm btn-outline-primary" (click)="showEditUserForm(utilisateur)">
            <i class="fas fa-edit"></i> Modifier
          </button>
          <button class="btn btn-sm btn-outline-danger" (click)="deleteUser(utilisateur)">
            <i class="fas fa-trash"></i> Supprimer
          </button>
        </div>
      </div>
    </div>

    <ng-template #noUsers>
      <div class="no-users">
        <i class="fas fa-users"></i>
        <h3>Aucun utilisateur trouvé</h3>
        <p *ngIf="searchTerm">Aucun utilisateur ne correspond à votre recherche.</p>
        <p *ngIf="!searchTerm">Aucun utilisateur n'a encore été créé.</p>
      </div>
    </ng-template>
  </div>
</div>
